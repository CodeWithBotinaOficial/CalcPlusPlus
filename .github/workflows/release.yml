name: Build and Publish CalcPlusPlus

on:
  release:
    types: [published]

jobs:
  build-deb:
    runs-on: ubuntu-22.04 # Changed to ubuntu-22.04

    permissions:
      contents: write
      packages: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y qt6-base-dev qt6-base-dev-tools qt6-base-dev-bin libsqlite3-dev cmake ninja-build # System Qt6

      - name: Build CalcPlusPlus and Generate .deb
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/cmake/Qt6 # Explicit Qt6 path
          cmake --build build --config Release
          cd build
          cpack -G DEB

      - name: Upload .deb to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GH_PAT_FOR_RELEASES }}
          tag_name: ${{ github.ref_name }}
          files: build/*.deb
          overwrite_files: true
          draft: false
          prerelease: false
          allow_updates: true

      - name: Publish .deb to GitHub Packages
        run: |
          DEB_FILE=$(find build -name "calcplusplus_*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "Error: .deb file not found in build/ directory." >&2
            exit 1
          fi

          PACKAGE_NAME=$(echo "$DEB_FILE" | sed -E 's|build/(.*)_[0-9]+\\.[0-9]+\\.[0-9]+_amd64\\.deb|\\1|')
          PACKAGE_VERSION=$(echo "$DEB_FILE" | sed -E 's|build/.*_([0-9]+\\.[0-9]+\\.[0-9]+)_amd64\\.deb|\\1|')

          echo "Publishing $DEB_FILE to GitHub Packages..."
          echo "Package Name: $PACKAGE_NAME"
          echo "Package Version: $PACKAGE_VERSION"

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GH_PAT_FOR_RELEASES }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@$DEB_FILE" \
            "https://api.github.com/repos/${{ github.repository }}/packages/generic/${PACKAGE_NAME}/versions"

      # Optional: Upload build artifact for debugging or later use.
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: calcplusplus-deb
          path: build/*.deb
